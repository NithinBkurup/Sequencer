<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuration - MPAS</title>
  <link rel="stylesheet" href="config.css">
</head>
<body>
  <div class="main-container">
    <div class="header">
      <h1>‚öôÔ∏è Configuration</h1>
      <div class="subtitle">Manage database and application settings</div>
    </div>

    <div class="alert" id="alertBox"></div>

    <div class="config-panel">
      <h2>üóÑÔ∏è Database Configuration</h2>
      
      <div class="form-group">
        <label for="dbHost">Database Host</label>
        <div class="description">SQL Server hostname or IP address</div>
        <input type="text" id="dbHost" placeholder="e.g., localhost or 192.168.1.100">
      </div>

      <div class="form-group">
        <label for="dbPort">Database Port</label>
        <div class="description">SQL Server port (default: 1433)</div>
        <input type="number" id="dbPort" placeholder="1433">
      </div>

      <div class="form-group">
        <label for="dbName">Database Name</label>
        <div class="description">Name of the database to connect to</div>
        <input type="text" id="dbName" placeholder="e.g., MPAS_DB">
      </div>

      <div class="form-group">
        <label for="dbUser">Database User</label>
        <div class="description">SQL Server username</div>
        <input type="text" id="dbUser" placeholder="e.g., sa or mpas_user">
      </div>

      <div class="form-group toggle-password">
        <label for="dbPass">Database Password</label>
        <div class="description">SQL Server password (will be encrypted in .env file)</div>
        <input type="password" id="dbPass" class="password-field" placeholder="Enter database password">
        <button type="button" class="eye-btn" onclick="togglePassword('dbPass')">üëÅÔ∏è</button>
      </div>

      <div class="actions">
        <button class="btn btn-test" onclick="testConnection()">
          üîå Test Connection
        </button>
      </div>

      <div class="test-result" id="testResult"></div>

      <div class="section-divider"></div>

      <h2>üöÄ Application Configuration</h2>

      <div class="form-group">
        <label for="appPort">Application Port</label>
        <div class="description">Port number for the web server (default: 3010)</div>
        <input type="number" id="appPort" placeholder="3010">
      </div>

      <div class="current-values">
        <div class="label">üìã Current Configuration (from .env file):</div>
        <div id="currentConfig">
          <div class="value">Loading current configuration...</div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-secondary" onclick="loadCurrentConfig()">
        üîÑ Reload Current
      </button>
      <button class="btn btn-primary" onclick="saveConfig()" id="saveBtn">
        üíæ Save Configuration
      </button>
    </div>
  </div>

  <script>
    let currentEnv = {};

    // Load current configuration on page load
    window.addEventListener('DOMContentLoaded', loadCurrentConfig);

    function togglePassword(fieldId) {
      const field = document.getElementById(fieldId);
      const btn = field.nextElementSibling;
      
      if (field.type === 'password') {
        field.type = 'text';
        btn.textContent = 'üôà';
      } else {
        field.type = 'password';
        btn.textContent = 'üëÅÔ∏è';
      }
    }

    async function loadCurrentConfig() {
      try {
        const response = await fetch('/api/config');
        
        if (response.ok) {
          currentEnv = await response.json();
          
          // Populate form fields
          document.getElementById('dbHost').value = currentEnv.MPAS_DB_HOST || '';
          document.getElementById('dbPort').value = currentEnv.MPAS_DB_PORT || '1433';
          document.getElementById('dbName').value = currentEnv.MPAS_DB_NAME || '';
          document.getElementById('dbUser').value = currentEnv.MPAS_DB_USER || '';
          document.getElementById('dbPass').value = currentEnv.MPAS_DB_PASS || '';
          document.getElementById('appPort').value = currentEnv.MPAS_APP_PORT || '3010';
          
          // Display current values
          const currentConfigDiv = document.getElementById('currentConfig');
          currentConfigDiv.innerHTML = `
            <div class="value">MPAS_DB_HOST = ${currentEnv.MPAS_DB_HOST || '(not set)'}</div>
            <div class="value">MPAS_DB_PORT = ${currentEnv.MPAS_DB_PORT || '(not set)'}</div>
            <div class="value">MPAS_DB_NAME = ${currentEnv.MPAS_DB_NAME || '(not set)'}</div>
            <div class="value">MPAS_DB_USER = ${currentEnv.MPAS_DB_USER || '(not set)'}</div>
            <div class="value">MPAS_DB_PASS = ${'*'.repeat((currentEnv.MPAS_DB_PASS || '').length) || '(not set)'}</div>
            <div class="value">MPAS_APP_PORT = ${currentEnv.MPAS_APP_PORT || '(not set)'}</div>
          `;
          
          showAlert('Configuration loaded successfully', 'success');
        } else {
          showAlert('Could not load current configuration', 'info');
        }
      } catch (error) {
        console.error('Error loading config:', error);
        showAlert('Error loading configuration: ' + error.message, 'error');
      }
    }

    async function saveConfig() {
      const config = {
        MPAS_DB_HOST: document.getElementById('dbHost').value.trim(),
        MPAS_DB_PORT: document.getElementById('dbPort').value.trim(),
        MPAS_DB_NAME: document.getElementById('dbName').value.trim(),
        MPAS_DB_USER: document.getElementById('dbUser').value.trim(),
        MPAS_DB_PASS: document.getElementById('dbPass').value,
        MPAS_APP_PORT: document.getElementById('appPort').value.trim()
      };

      // Validation
      if (!config.MPAS_DB_HOST || !config.MPAS_DB_NAME || !config.MPAS_DB_USER) {
        showAlert('Please fill in all required database fields (Host, Name, User)', 'error');
        return;
      }

      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '‚è≥ Saving...';

      try {
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        if (response.ok) {
          showAlert('‚úÖ Configuration saved successfully! Please restart the server for changes to take effect.', 'success');
          await loadCurrentConfig();
        } else {
          const error = await response.text();
          showAlert('Failed to save configuration: ' + error, 'error');
        }
      } catch (error) {
        showAlert('Error saving configuration: ' + error.message, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'üíæ Save Configuration';
      }
    }

    async function testConnection() {
      const testResult = document.getElementById('testResult');
      testResult.classList.remove('show', 'success', 'error');
      testResult.innerHTML = '‚è≥ Testing connection...';
      testResult.classList.add('show');

      try {
        const response = await fetch('/api/test');
        const result = await response.json();

        if (result.success) {
          testResult.className = 'test-result show success';
          testResult.innerHTML = `
            ‚úÖ Connection successful!
            <pre>${result.message}
Version: ${result.version}</pre>
          `;
        } else {
          testResult.className = 'test-result show error';
          testResult.innerHTML = `
            ‚ùå Connection failed
            <pre>${result.error}
${result.code ? 'Code: ' + result.code : ''}
${result.originalError || ''}</pre>
          `;
        }
      } catch (error) {
        testResult.className = 'test-result show error';
        testResult.innerHTML = `
          ‚ùå Test failed: ${error.message}
        `;
      }
    }

    function showAlert(message, type) {
      const alertBox = document.getElementById('alertBox');
      alertBox.className = `alert alert-${type} show`;
      alertBox.textContent = message;

      if (type === 'success') {
        setTimeout(() => {
          alertBox.classList.remove('show');
        }, 5000);
      }
    }
  </script>
</body>
</html>